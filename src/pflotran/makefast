# $Id: makefile,v 1.3 2004/07/31 01:16:44 lichtner Exp $

objdir = ./${PETSC_ARCH}/obj
srcdir = ./
pflotran_src = ./
common_src   = ./
bindir = ./${PETSC_ARCH}/bin

MYFLAGS = -I${objdir} 

ifdef hdf5-vamsi
    MYFLAGS += -DVAMSI_HDF5 -DVAMSI_HDF5_READ -DVAMSI_HDF5_WRITE -DVAMSI_STAGE_BARRIER
endif   

ifdef compile_broken
  MYFLAGS += -DCOMPILE_BROKEN
endif

ifdef uo2
  MYFLAGS += -DCOMPUTE_INTERNAL_MASS_FLUX
endif

ifdef glenn
  #MYFLAGS += -DGLENN -DUGRID_DEBUG
  MYFLAGS += -DUGRID_DEBUG -UGRID_NEW
  #MYFLAGS += -DGLENN -DTVD_DEBUG
endif

ifdef solid_solution
  MYFLAGS += -DSOLID_SOLUTION
endif

ifdef radioactive_decay
  MYFLAGS += -DRADIOACTIVE_DECAY
endif

ifdef matcreate_old
  MYFLAGS += -DMATCREATE_OLD
endif

ifdef mualem_spline
  MYFLAGS += -DMUALEM_SPLINE
endif

ifdef snes_old
  MYFLAGS += -DHAVE_SNES_API_3_2
endif

ifdef snes_api_3_2
  MYFLAGS += -DHAVE_SNES_API_3_2
endif

ifdef petsc_api_3_3
  MYFLAGS += -DHAVE_PETSC_API_3_3
endif

ifdef dbl
  MYFLAGS += -DDOUBLE_LAYER
endif

ifdef pcl
  MYFLAGS += -DPCL -DMUALEM_SPLINE
endif

ifdef tab
  MYFLAGS += -DTABLE
endif

ifdef temp
  MYFLAGS += -DTEMP_DEPENDENT_LOGK
endif

ifdef ice
  MYFLAGS += -DICE
endif

ifdef remove_sat
  MYFLAGS += -DREMOVE_SATURATION
endif

ifdef compressibility
  MYFLAGS += -DUSE_COMPRESSIBILITY
endif

ifdef no_vapor_diffusion
  MYFLAGS += -DNO_VAPOR_DIFFUSION
endif

ifdef scco2
  MYFLAGS += -DCHUAN_CO2
endif

ifdef debug_gen
  MYFLAGS += -DDEBUG_GENERAL
endif 

ifdef coll
  MYFLAGS += -DCOLL
endif

ifdef dont_use_wateos
  MYFLAGS += -DDONT_USE_WATEOS
endif

ifdef vamsi_hdf5
  MYFLAGS += -DVAMSI_HDF5 -DVAMSI_DEFAULT -DVAMSI_HDF5_READ -DVAMSI_HDF5_WRITE -DVAMSI_STAGE_BARRIER
endif

ifdef have_hdf5
  MYFLAGS += -I$(HDF5_INCLUDE) -I$(HDF5_LIB) -DPETSC_HAVE_HDF5
endif

ifdef gpu
  MYFLAGS += -DCHUNK
endif

ifdef mfd
  MYFLAGS += -DDASVYAT
endif

ifdef dasvyat_debug
  MYFLAGS += -DDASVYAT_DEBUG
endif

ifdef dasvyat_test_cut
  MYFLAGS += -DDASVYAT_TEST_CUT
endif

ifdef gautam
  MYFLAGS += -w -g #-DSURFACE_FLOW #-DUGRID_DEBUG #-DPARALLELIO_LIB -DOS_STATISTICS 
endif

ifdef surface_flow
  MYFLAGS += -DSURFACE_FLOW
endif

ifdef amanzi_bgd
  MYFLAGS += -DAMANZI_BGD
endif

CFLAGS		 = 
FFLAGS		 =
CPPFLAGS         = ${MYFLAGS}
FPPFLAGS         = ${MYFLAGS}

CLEANFILES       = pflotran 

ifdef petscrel
 include ${PETSC_DIR}/bmake/common/base
else
 include ${PETSC_DIR}/conf/variables
 include ${PETSC_DIR}/conf/rules
endif

ifdef have_hdf5
LIBS +=  -L${HDF5_LIB} -lhdf5_fortran -lhdf5 -lz 
endif

ifdef have_parallelio_lib
LIBS += -L${PARALLELIO_LIB} -lparallelio
endif

ifdef tau
FC = /ccs/proj/geo002/tau/tau-2.19.1/craycnl/bin/tau_f90.sh -optCompInst -tau_makefile=$(TAU_MAKEFILE)
FLINKER = /ccs/proj/geo002/tau/tau-2.19.1/craycnl/bin/tau_f90.sh -optCompInst -tau_makefile=$(TAU_MAKEFILE)
endif

util_obj  = ${common_src}input.o \
	${common_src}string.o \
	${common_src}water_eos.o \
	${common_src}gaseos_mod.o \
	${common_src}co2eos.o \
	${common_src}co2_sw_rtsafe.o \
	${common_src}co2_span_wagner.o \
	${common_src}spline.o \
	${common_src}co2_span_wagner_spline.o \
	${common_src}co2_sw.o \
	${common_src}utility.o

pflotran_obj = ${common_src}option.o \
	${common_src}geometry.o\
	${common_src}units.o\
	${common_src}logging.o \
	${common_src}hdf5_aux.o \
	${common_src}global_aux.o\
	${common_src}material_aux.o\
	${common_src}matrix_block_aux.o\
	${common_src}database_aux.o\
	${common_src}surface_complexation_aux.o\
	${common_src}mineral_aux.o\
	${common_src}solid_solution_aux.o\
	${common_src}reaction_aux.o\
	${common_src}reactive_transport_aux.o\
	${common_src}secondary_continuum.o\
	${common_src}thc_aux.o\
	${common_src}thmc_aux.o\
	${common_src}richards_aux.o\
	${common_src}general_aux.o\
	${common_src}mphase_aux.o\
	${common_src}miscible_aux.o\
	${common_src}immis_aux.o\
	${common_src}mfd_aux.o\
	${common_src}flash2_aux.o\
	${common_src}auxilliary.o\
	${common_src}field.o \
	${common_src}debug.o \
	${common_src}waypoint.o \
	${common_src}region.o \
	${common_src}fluid.o \
	${common_src}time_series.o \
	${common_src}dataset_aux.o \
	${common_src}dataset.o \
	${common_src}saturation_function.o \
	${common_src}material.o \
	${common_src}pckr_mod.o \
	${common_src}strata.o \
	${common_src}connection.o \
	${common_src}observation.o \
	${common_src}solver.o \
	${common_src}cf90bridge.o\
	${common_src}unstructured_cell.o \
	${common_src}unstructured_explicit.o \
	${common_src}unstructured_grid_aux.o \
	${common_src}unstructured_grid.o \
	${common_src}structured_grid.o \
	${common_src}condition.o \
	${common_src}coupler.o \
	${common_src}grid.o \
	${common_src}matrix_buffer.o \
	${common_src}hydrostatic.o \
	${common_src}saturation.o \
	${common_src}patch.o \
	${common_src}mfd.o\
	${common_src}level.o \
	${common_src}discretization.o \
	${common_src}database.o \
	${common_src}database_hpt.o \
	${common_src}velocity.o \
	${common_src}realization.o \
	${common_src}hdf5.o \
	${common_src}global.o \
	${common_src}mphase.o\
	${common_src}immis.o\
	${common_src}miscible.o\
	${common_src}flash2.o\
	${common_src}transport.o\
	${common_src}surface_complexation.o\
	${common_src}mineral.o\
	${common_src}solid_solution.o\
	${common_src}reaction.o\
	${common_src}reactive_transport.o\
	${common_src}thc.o\
	${common_src}thmc.o\
	${common_src}richards.o\
	${common_src}general.o\
	${common_src}condition_control.o \
	${common_src}general_grid.o \
	${common_src}checkpoint.o \
	${common_src}convergence.o \
	${common_src}timestepper.o \
	${common_src}simulation.o \
	${common_src}stochastic_aux.o \
	${common_src}stochastic.o \
	${common_src}surface_field.o \
	${common_src}surface_flow_aux.o \
	${common_src}surface_flow.o \
	${common_src}surface_material.o \
	${common_src}surface_realization.o \
	${common_src}output.o \
	${common_src}init.o
#	${common_src}reaction_chunk.o\

pflotran : $(util_obj) ${pflotran_obj} ${pflotran_src}pflotran.o
	${FLINKER} -o pflotran $(util_obj) ${pflotran_obj} ${pflotran_src}pflotran.o ${PETSC_LIB} ${LIBS} 

ascii_to_hdf5: input.o hdf5_dataset.o ascii_to_hdf5.o 
	${FLINKER} -o ascii_to_hdf5 ascii_to_hdf5.o hdf5_dataset.o input.o \
	$(LIBS)

test: functions.o test.o
	${FLINKER} -o test test.o functions.o $(LIBS) $(PETSC_LIB)

# Should add this to default PETSc targets as well?
%.mod : %.F90
	${FC} -c ${FC_FLAGS} ${FFLAGS} ${FCPPFLAGS} $<

# Dependencies stemming from "use" statements.
# These ensure that the module files are built in the correct order.
